<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.core.product.mapper.ProductMapper">

    <!-- Product ResultMap -->
    <resultMap id="ProductResultMap" type="com.core.product.entity.Product">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="imageUrl" column="image_url"/>
        <result property="brandId" column="brand_id"/>
        <result property="brandName" column="brand_name"/>
        <result property="mdKeyword" column="md_keyword"/>
        <result property="originalPrice" column="original_price"/>
        <result property="discountPrice" column="discount_price"/>
        <result property="discountPriceWon" column="discount_price_won"/>
        <result property="discountRate" column="discount_rate"/>
        <result property="flags" column="flags"/>
        <result property="isSoldOut" column="is_sold_out"/>
        <result property="requiresAdultVerification" column="requires_adult_verification"/>
        <result property="isAdultVerified" column="is_adult_verified"/>
        <result property="requiresLoginForDiscount" column="requires_login_for_discount"/>
        <result property="isLoggedIn" column="is_logged_in"/>
    </resultMap>

    <!-- ProductSetItem ResultMap -->
    <resultMap id="ProductSetItemResultMap" type="com.core.product.entity.ProductSetItem">
        <id property="id" column="id"/>
        <result property="productSetId" column="product_set_id"/>
        <result property="productId" column="product_id"/>
        <result property="displayOrder" column="display_order"/>
    </resultMap>

    <!-- 추천 상품 목록 조회 (할인율 높은 순) -->
    <select id="findRecommendedProducts" resultMap="ProductResultMap">
        SELECT
            p.id,
            p.name,
            p.image_url,
            p.brand_id,
            b.name AS brand_name,
            p.md_keyword,
            p.original_price,
            p.discount_price,
            p.discount_price_won,
            p.discount_rate,
            p.flags,
            p.is_sold_out,
            p.requires_adult_verification,
            p.is_adult_verified,
            p.requires_login_for_discount,
            p.is_logged_in
        FROM products p
        LEFT JOIN brands b ON p.brand_id = b.id
        ORDER BY p.discount_rate DESC NULLS LAST, p.id ASC
    </select>

    <!-- ID 목록으로 상품 조회 -->
    <select id="findByIds" resultMap="ProductResultMap">
        SELECT
            p.id,
            p.name,
            p.image_url,
            p.brand_id,
            b.name AS brand_name,
            p.md_keyword,
            p.original_price,
            p.discount_price,
            p.discount_price_won,
            p.discount_rate,
            p.flags,
            p.is_sold_out,
            p.requires_adult_verification,
            p.is_adult_verified,
            p.requires_login_for_discount,
            p.is_logged_in
        FROM products p
        LEFT JOIN brands b ON p.brand_id = b.id
        WHERE p.id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY p.id ASC
    </select>

    <!-- 단일 상품 조회 -->
    <select id="findById" resultMap="ProductResultMap">
        SELECT
            p.id,
            p.name,
            p.image_url,
            p.brand_id,
            b.name AS brand_name,
            p.md_keyword,
            p.original_price,
            p.discount_price,
            p.discount_price_won,
            p.discount_rate,
            p.flags,
            p.is_sold_out,
            p.requires_adult_verification,
            p.is_adult_verified,
            p.requires_login_for_discount,
            p.is_logged_in
        FROM products p
        LEFT JOIN brands b ON p.brand_id = b.id
        WHERE p.id = #{id}
    </select>

    <!-- ProductSet의 Item 목록 조회 -->
    <select id="findProductSetItemsByProductSetId" resultMap="ProductSetItemResultMap">
        SELECT
            id,
            product_set_id,
            product_id,
            display_order
        FROM product_set_items
        WHERE product_set_id = #{productSetId}
        ORDER BY display_order ASC
    </select>

</mapper>

