<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.core.product.mapper.ProductMapper">

    <!-- Product ResultMap -->
    <resultMap id="ProductResultMap" type="com.core.product.entity.Product">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="imageUrl" column="image_url"/>
        <result property="brandId" column="brand_id"/>
        <result property="brandName" column="brand_name"/>
        <result property="mdKeyword" column="md_keyword"/>
        <result property="originalPrice" column="original_price"/>
        <result property="discountPrice" column="discount_price"/>
        <result property="discountPriceWon" column="discount_price_won"/>
        <result property="discountRate" column="discount_rate"/>
        <result property="flags" column="flags"/>
        <result property="isSoldOut" column="is_sold_out"/>
        <result property="requiresAdultVerification" column="requires_adult_verification"/>
        <result property="isAdultVerified" column="is_adult_verified"/>
        <result property="requiresLoginForDiscount" column="requires_login_for_discount"/>
        <result property="isLoggedIn" column="is_logged_in"/>
        <result property="videoUrl" column="video_url"/>
    </resultMap>

    <!-- Product 공통 컬럼 정의 -->
    <sql id="ProductColumns">
        p.id,
        p.name,
        p.image_url,
        p.brand_id,
        b.brand_name,
        p.md_keyword,
        p.original_price,
        p.discount_price,
        p.discount_price_won,
        p.discount_rate,
        p.flags,
        p.is_sold_out,
        p.requires_adult_verification,
        p.is_adult_verified,
        p.requires_login_for_discount,
        p.is_logged_in,
        p.video_url
    </sql>

    <!-- 전체 상품 목록 조회 -->
    <select id="getAllProducts" resultMap="ProductResultMap"> 
        SELECT 
            <include refid="ProductColumns" />
        FROM products p
        LEFT JOIN brands b ON p.brand_id = b.id
        ORDER BY p.id ASC
    </select>

    <!-- ID 목록으로 상품 목록 조회 -->
    <select id="getProductByIds" resultMap="ProductResultMap">
        SELECT
            <include refid="ProductColumns" />
        FROM products p
        LEFT JOIN brands b ON p.brand_id = b.id
        WHERE p.id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY p.id ASC
    </select>

    <!-- 단일 상품 조회 -->
    <select id="getProductById" resultMap="ProductResultMap">
        SELECT
            <include refid="ProductColumns" />
        FROM products p
        LEFT JOIN brands b ON p.brand_id = b.id
        WHERE p.id = #{id}
    </select>

    <!-- 추천 상품 목록 조회 -->
    <select id="getRecommendedProducts" resultMap="ProductResultMap">
        SELECT
            <include refid="ProductColumns" />
        FROM products p
        INNER JOIN event_products ep ON p.id = ep.product_id
        LEFT JOIN brands b ON p.brand_id = b.id
        WHERE ep.event_id = #{eventId}
          AND ep.is_recommend = true
        ORDER BY ep.display_order ASC, p.id ASC
    </select>

    <!-- eventId로 상품 목록 조회 -->
    <select id="getProductsByEventId" resultMap="ProductResultMap">
        SELECT
            <include refid="ProductColumns" />
        FROM products p
        INNER JOIN event_products ep ON p.id = ep.product_id
        LEFT JOIN brands b ON p.brand_id = b.id
        WHERE ep.event_id = #{eventId}
        ORDER BY ep.display_order ASC, p.id ASC
    </select>

    <!-- eventId와 brandId로 상품 목록 조회  -->
    <select id="getProductsByEventIdAndBrandIds" resultMap="ProductResultMap">
        SELECT
            <include refid="ProductColumns" />
        FROM products p
        INNER JOIN event_products ep ON p.id = ep.product_id
        LEFT JOIN brands b ON p.brand_id = b.id
        WHERE ep.event_id = #{eventId}
        <if test="brandIds != null and !brandIds.isEmpty()">
          AND p.brand_id IN
          <foreach collection="brandIds" item="brandId" open="(" separator="," close=")">
              #{brandId}
          </foreach>
        </if>
        ORDER BY ep.display_order ASC, p.id ASC
    </select>
    
    <!-- brandId 목록으로 상품 목록 조회  -->


</mapper>

